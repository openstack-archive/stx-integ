From 96faa7c807d77a7d3499a9c78f5fd16cb53543bf Mon Sep 17 00:00:00 2001
From: Kristine Bujold <kristine.bujold@windriver.com>
Date: Wed, 6 Jun 2018 07:11:04 -0400
Subject: [PATCH 1/1] Fix horizon user session timeout

---
 django/contrib/sessions/backends/file.py | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/django/contrib/sessions/backends/file.py b/django/contrib/sessions/backends/file.py
index 2b10b3e..28aad15 100644
--- a/django/contrib/sessions/backends/file.py
+++ b/django/contrib/sessions/backends/file.py
@@ -71,16 +71,22 @@ class SessionStore(SessionBase):
             modification = datetime.datetime.fromtimestamp(modification)
         return modification
 
+    # Fix horizon user session timeout
     def _expiry_date(self, session_data):  
         """  
         Return the expiry time of the file storing the session's content.
         """
+        expiry_date = None
         expiry = session_data.get('_session_expiry')
-        if not expiry:
-            expiry = self._last_modification() + datetime.timedelta(seconds=settings.SESSION_COOKIE_AGE)
-        elif not isinstance(expiry, datetime.datetime):
-            expiry = self._last_modification() + datetime.timedelta(seconds=expiry)
-        return expiry
+        login_date = session_data.get('_user_login')
+
+        if login_date:
+            if not expiry:
+                expiry_date = login_date + datetime.timedelta(seconds=settings.SESSION_COOKIE_AGE)
+            elif not isinstance(expiry, datetime.datetime):
+                expiry_date = login_date + datetime.timedelta(seconds=expiry)
+
+        return expiry_date
 
     def load(self):
         session_data = {}
@@ -99,7 +105,7 @@ class SessionStore(SessionBase):
                         logger.warning(force_text(e))
                     self.create()
 
-                # Remove expired sessions.
+                # Remove expired sessions based on user login time
                 expiry_age = self.get_expiry_age(expiry=self._expiry_date(session_data))
                 if expiry_age < 0:
                     session_data = {}
-- 
1.8.3.1

